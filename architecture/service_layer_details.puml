@startuml service_layer_details
title Service Layer â€“ Agent Service Components

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam rectangle {
  BorderColor #000000
  BorderThickness 1
}

rectangle "Service Layer (FastAPI)\nservices/agent_ai\n**Handles: Agent Orchestration + APIs + RAG Calls + Analysis**" as SERVICE {
  rectangle "API Gateway & Middleware\n(auth, rate limiting, CORS)" as MIDDLEWARE
  rectangle "Auth & Session Module\n(/api/v1/auth/*)" as AUTH
  rectangle "Chatbot Controller\n(/api/v1/chatbot/*)" as CHAT
  rectangle "Document Proxy\n(/api/v1/documents/*)" as DOCS
  rectangle "LangGraph Agent\n(orchestrates tools, memory, state)" as GRAPH
  rectangle "Analysis Components\n(decision, rules, scenarios)" as ANALYSIS
  rectangle "Observability Hooks\n(Prometheus, Langfuse)" as OBS
}

rectangle "External Services" as EXT {
  rectangle "RAG Service\n(rag_api)\nvector search, embeddings" as RAG
  rectangle "LLM Provider\n(OpenAI)" as LLM
  rectangle "Observability Stack\n(Prometheus, Grafana, Langfuse)" as PROM
}

database "Postgres\n(pgvector)" as DB

AUTH --> MIDDLEWARE : JWT validation, rate limiting
CHAT --> GRAPH : invoke agent workflows
DOCS --> RAG : proxy document operations
GRAPH --> RAG : rag_search tool (authenticated)
GRAPH --> ANALYSIS : invoke strategic analysis
ANALYSIS --> DB : store analysis results
GRAPH --> LLM : prompt completion
GRAPH --> DB : load/save checkpoints & state
AUTH --> DB : sessions, users
OBS --> PROM : metrics & traces

@enduml
