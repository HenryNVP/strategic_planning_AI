@startuml A30_layer_knowledge_data
title Knowledge/Data Layer – Storage & Retrieval

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam rectangle {
  BorderColor #000000
  BorderThickness 1
}

package "Knowledge/Data Layer - Storage" as KNOWLEDGE_LAYER {
  
  rectangle "**Relational Database**\nPostgres" as RELATIONAL_DB {
    rectangle "**Application Data**\n• Users & sessions\n• Conversation state\n• Checkpoints\n• Workflow data" as APP_DATA
    rectangle "**University Domain Data**\n• Courses & programs\n• Students & enrollments\n• Faculty & departments\n• Resources & budgets" as DOMAIN_DATA
  }
  
  rectangle "**Vector Store**\nPostgres + pgvector" as VECTOR_STORE {
    rectangle "• Document chunks\n• Vector embeddings\n• Metadata\n• Similarity indices" as VECTOR_CORE
  }
  
  rectangle "**Knowledge Graph**\nNeo4j" as KNOWLEDGE_GRAPH {
    rectangle "• Entity nodes\n• Relationships\n• Domain ontology\n• Graph indices" as GRAPH_CORE
  }
}

' Services that use this layer
cloud "Agent Service\n(Layer 20 - Port 8000)" as AGENT_SERVICE
cloud "RAG Service\n(Layer 20 - Port 8080)" as RAG_SERVICE
cloud "Analysis Service\n(Layer 20 - Port 8090)" as ANALYSIS_SERVICE
cloud "OpenAI\nEmbeddings API" as OPENAI

' Agent Service uses Application Data
AGENT_SERVICE --> APP_DATA : sessions, users, checkpoints

' RAG Service uses Vector Store & Graph
RAG_SERVICE --> OPENAI : generate embeddings
RAG_SERVICE --> VECTOR_STORE : chunks + vectors
RAG_SERVICE --> KNOWLEDGE_GRAPH : entities + relations

' Analysis Service uses both Application & Domain Data
ANALYSIS_SERVICE --> APP_DATA : workflow state, results
ANALYSIS_SERVICE --> DOMAIN_DATA : query university data for analysis

note bottom of RELATIONAL_DB
**Relational Database** (Postgres)
**Application Data:**
- Users, sessions, auth
- Checkpoints (LangGraph)
- Workflow state

**University Domain Data:**
- Courses, programs, departments
- Student enrollments, grades
- Faculty, staff, resources
- Budget, financial data
- Used by Analysis Service
end note

note bottom of VECTOR_STORE
**Vector Store**
Same Postgres + pgvector extension
- Document chunks (text)
- Vector embeddings
- Similarity search
end note

note bottom of KNOWLEDGE_GRAPH
**Knowledge Graph**
Separate Neo4j instance
- Entity nodes
- Relationships
- Domain ontology
- Graph traversal
end note

@enduml
