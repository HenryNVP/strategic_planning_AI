@startuml A30_layer_knowledge_data
title Knowledge Layer â€“ RAG Service Components

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam rectangle {
  BorderColor #000000
  BorderThickness 1
}

rectangle "RAG Service (FastAPI)\nservices/rag_api" as RAG_SERVICE {
  rectangle "Security Middleware\n(JWT validation)" as SECURITY
  
  package "Ingestion Pipeline" as INGESTION {
    rectangle "Document Upload\n(/embed, /embed-upload)" as UPLOAD
    rectangle "File Loader\n(PDF, CSV, DOCX, etc.)" as LOADER
    rectangle "Text Extraction\n& Cleaning" as EXTRACTOR
    rectangle "Text Chunking\n(RecursiveCharacterTextSplitter)" as CHUNKER
    rectangle "Embedding Generator\n(async workers)" as EMBEDDER
    rectangle "Entity Extractor\n(NER, relationship extraction)" as NER
  }
  
  package "Query Pipeline" as QUERY_PIPE {
    rectangle "Vector Search\n(/query, /query_multiple)" as SEARCH
    rectangle "Similarity Ranking\n(pgvector)" as RANKING
    rectangle "Graph Query\n(Cypher)" as GRAPH_QUERY
    rectangle "Hybrid Retrieval\n(vector + graph)" as HYBRID
    rectangle "Context Retrieval" as RETRIEVAL
  }
}

database "Postgres + pgvector" as DB {
  rectangle "Document Chunks\n(text, metadata)" as CHUNKS
  rectangle "Vector Embeddings\n(pgvector)" as EMBEDDINGS
}

database "Neo4j Graph DB" as NEO4J {
  rectangle "Entity Nodes\n(people, orgs, concepts)" as ENTITIES
  rectangle "Relationships\n(edges, properties)" as RELATIONS
  rectangle "Domain Ontology\n(schema, rules)" as SCHEMA
}

cloud "OpenAI\nEmbeddings API" as EMB_SERVICE

' Ingestion flow
SECURITY --> UPLOAD : validate request
UPLOAD --> LOADER : load file
LOADER --> EXTRACTOR : extract text
EXTRACTOR --> CHUNKER : clean & chunk
CHUNKER --> EMBEDDER : generate embeddings
CHUNKER --> NER : extract entities
EMBEDDER --> EMB_SERVICE : API call
EMB_SERVICE --> EMBEDDER : return vectors
EMBEDDER --> CHUNKS : store chunks
EMBEDDER --> EMBEDDINGS : store vectors
NER --> ENTITIES : create nodes
NER --> RELATIONS : create edges
NER --> SCHEMA : update ontology

' Query flow
SECURITY --> SEARCH : validate request
SEARCH --> RANKING : vector similarity
SEARCH --> GRAPH_QUERY : graph traversal
RANKING --> EMBEDDINGS : vector lookup
GRAPH_QUERY --> ENTITIES : find entities
GRAPH_QUERY --> RELATIONS : traverse paths
RANKING --> HYBRID : vector results
GRAPH_QUERY --> HYBRID : graph results
HYBRID --> RETRIEVAL : merge & rank
RETRIEVAL --> CHUNKS : fetch content

note bottom of INGESTION
**Data Ingestion Pipeline:**
- Supports 15+ file formats
- Encoding detection (UTF-8, UTF-16, etc.)
- Configurable chunk size & overlap
- Parallel embedding generation
- Entity & relationship extraction (NER)
- Metadata tracking (file_id, user_id, digest)
end note

note bottom of QUERY_PIPE
**Hybrid Query Pipeline:**
- Vector similarity search (semantic)
- Graph traversal (structural relationships)
- Hybrid retrieval (vector + graph)
- Configurable top-k results
- Multi-file query support
- User-based access control
end note

note right of NEO4J
**Knowledge Graph Features:**
- Entity recognition & linking
- Relationship extraction
- Graph-based reasoning
- Cypher query language
- Domain ontology modeling
- Graph analytics & traversal
end note

@enduml
