@startuml A20_layer_service_microservices
title Service Layer – Microservices Overview

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam rectangle {
  BorderColor #000000
  BorderThickness 1
}

package "Service Layer - Microservices" as SERVICE_LAYER {
  
  rectangle "**Agent Service**\nservices/agent_ai\nPort: 8000" as AGENT {
    rectangle "• LangGraph orchestration\n• Chat API (sync/stream)\n• Auth & sessions\n• Tool coordination" as AGENT_CORE
  }
  
  rectangle "**RAG Service**\nservices/rag_api\nPort: 8080" as RAG {
    rectangle "• Document processing\n• Vector search (pgvector)\n• Knowledge graph (Neo4j)\n• Entity extraction" as RAG_CORE
  }
  
  rectangle "**Analysis Service**\nservices/analysis_api\nPort: 8090" as ANALYSIS {
    rectangle "• Strategic workflows\n• Rules & compliance\n• Scenario simulation\n• Optimization" as ANALYSIS_CORE
  }
}

database "Postgres\n+ pgvector" as DB
database "Neo4j" as NEO4J
cloud "OpenAI" as OPENAI
cloud "Observability" as OBS

' Service interactions
AGENT --> RAG : HTTP + JWT\nRAG search, docs
AGENT --> ANALYSIS : HTTP\nanalysis workflows
ANALYSIS --> RAG : HTTP\ncontext retrieval

' Data connections
AGENT --> DB : sessions, state
RAG --> DB : vectors
RAG --> NEO4J : graph
ANALYSIS --> DB : workflows

' External
AGENT --> OPENAI : LLM
RAG --> OPENAI : embeddings
AGENT --> OBS
RAG --> OBS
ANALYSIS --> OBS

note right of AGENT
**Stateful Orchestrator**
FastAPI + LangGraph + SQLModel
Main entry point for users
end note

note right of RAG
**Stateless Data Service**
FastAPI + LangChain
Storage (vector + graph)
end note

note right of ANALYSIS
**Compute Service**
FastAPI + Celery + Ray
Long-running workflows
Task queue (Redis)
end note

@enduml
