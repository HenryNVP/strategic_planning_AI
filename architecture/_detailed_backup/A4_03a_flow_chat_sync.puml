@startuml A4_03a_flow_chat_sync
title Chat Flow (Sync) â€“ Standard Request/Response

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11

actor User
participant "Web UI" as UI
participant "Chat API" as CHAT
participant "LangGraph" as GRAPH
participant "RAG API" as RAG
database "Postgres" as DB
participant "OpenAI" as LLM

User -> UI : type message
UI -> CHAT : POST /chatbot/chat\n{message, session_id, JWT}
activate CHAT

CHAT -> GRAPH : invoke(session_id, messages)
activate GRAPH

' RAG retrieval
GRAPH -> RAG : POST /query\n{query, file_ids}
activate RAG
RAG -> DB : similarity_search(vector)
DB --> RAG : chunks + metadata
RAG --> GRAPH : contextual passages
deactivate RAG

' Get history
GRAPH -> DB : load conversation history
DB --> GRAPH : previous messages

' Generate response
GRAPH -> LLM : generate(prompt + context + history)
activate LLM
LLM --> GRAPH : complete response
deactivate LLM

' Save state
GRAPH -> DB : save checkpoint
GRAPH --> CHAT : message list
deactivate GRAPH

CHAT --> UI : ChatResponse {messages, citations}
deactivate CHAT

UI -> User : display complete response

@enduml

