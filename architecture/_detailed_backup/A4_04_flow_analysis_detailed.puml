@startuml A4_04_flow_analysis_workflow
title Analysis Workflow â€“ Strategic Decision Making

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam rectangle {
  BorderColor #000000
  BorderThickness 1
}

actor User
participant "LangGraph Agent" as LANGGRAPH
participant "Analysis API\n(/api/v1/analysis)" as ANALYSIS
participant "Decision Hub" as DECISION
participant "Rules Engine" as RULES
participant "Scenario Service" as SCENARIO
participant "Optimization Service" as OPTIM
participant "RAG API" as RAG
database "Postgres\n(domain data)" as PG
database "Redis\n(task queue)" as REDIS
participant "Observability" as OBS

== Workflow Initiation ==
User -> LANGGRAPH : "Analyze enrollment trends"
activate LANGGRAPH
LANGGRAPH -> LANGGRAPH : detect analysis intent
LANGGRAPH -> ANALYSIS : POST /analysis/workflows\n{type: "enrollment_analysis",\nstrategy_id, context}
activate ANALYSIS
ANALYSIS -> DECISION : enqueue_workflow(params)
activate DECISION
DECISION -> REDIS : push task to queue
activate REDIS
REDIS --> DECISION : task_id
deactivate REDIS
DECISION --> ANALYSIS : workflow_id, status: "queued"
deactivate DECISION
ANALYSIS --> LANGGRAPH : {workflow_id, status}
deactivate ANALYSIS
LANGGRAPH --> User : "Analysis started, workflow_id: xxx"
deactivate LANGGRAPH

== Workflow Execution ==
REDIS -> DECISION : pop task from queue
activate DECISION

group Phase 1: Context Retrieval
  DECISION -> RAG : GET /query\n{query: "enrollment historical data"}
  activate RAG
  RAG -> PG : fetch relevant documents
  RAG --> DECISION : contextual data
  deactivate RAG
  
  DECISION -> PG : query university_domain_data\n(enrollments, courses, faculty)
  activate PG
  PG --> DECISION : baseline data
  deactivate PG
end

group Phase 2: Rules & Compliance
  DECISION -> RULES : validate_constraints(data)
  activate RULES
  RULES -> PG : load policy rules
  activate PG
  PG --> RULES : compliance policies
  deactivate PG
  RULES -> RULES : evaluate constraints\n(budget limits, capacity, etc.)
  RULES --> DECISION : validation_result\n{compliant: true/false, issues: []}
  deactivate RULES
  
  alt not compliant
    DECISION -> DECISION : log compliance issues
    DECISION -> OBS : emit compliance failure
  end
end

group Phase 3: Scenario Simulation
  DECISION -> SCENARIO : run_scenarios(baseline, params)
  activate SCENARIO
  
  par parallel scenario execution
    SCENARIO -> SCENARIO : Scenario 1:\nCurrent trend continuation
    SCENARIO -> PG : calculate projections
    activate PG
    PG --> SCENARIO : scenario_1_results
    deactivate PG
  else
    SCENARIO -> SCENARIO : Scenario 2:\nIncreased capacity
    SCENARIO -> PG : calculate projections
    activate PG
    PG --> SCENARIO : scenario_2_results
    deactivate PG
  else
    SCENARIO -> SCENARIO : Scenario 3:\nReduced resources
    SCENARIO -> PG : calculate projections
    activate PG
    PG --> SCENARIO : scenario_3_results
    deactivate PG
  end
  
  SCENARIO -> SCENARIO : aggregate & rank scenarios
  SCENARIO -> PG : persist scenario results
  activate PG
  PG --> SCENARIO : saved
  deactivate PG
  SCENARIO --> DECISION : {scenarios, metrics, rankings}
  deactivate SCENARIO
end

group Phase 4: Optimization (Optional)
  alt optimization requested
    DECISION -> OPTIM : optimize(constraints, objectives)
    activate OPTIM
    OPTIM -> PG : fetch historical data
    activate PG
    PG --> OPTIM : data
    deactivate PG
    OPTIM -> OPTIM : run optimization solver\n(linear programming, etc.)
    OPTIM -> PG : save recommendations
    activate PG
    PG --> OPTIM : saved
    deactivate PG
    OPTIM --> DECISION : {optimal_strategy, expected_outcomes}
    deactivate OPTIM
  end
end

group Phase 5: Aggregation & Results
  DECISION -> DECISION : aggregate all findings:\n- Compliance status\n- Scenario comparisons\n- Optimization results
  DECISION -> PG : persist final analysis
  activate PG
  PG --> DECISION : analysis_id
  deactivate PG
  DECISION -> OBS : emit workflow telemetry\n(duration, success, metrics)
  DECISION --> ANALYSIS : {status: "completed",\nfindings, recommendations}
  deactivate DECISION
end

== Result Delivery ==
ANALYSIS --> LANGGRAPH : workflow complete (webhook or poll)
activate LANGGRAPH
activate ANALYSIS
LANGGRAPH -> ANALYSIS : GET /analysis/workflows/{workflow_id}
ANALYSIS --> LANGGRAPH : {results, evidence, citations}
deactivate ANALYSIS
LANGGRAPH -> LANGGRAPH : format results for user
LANGGRAPH --> User : "Analysis complete:\n[Summary of findings]"
deactivate LANGGRAPH

@enduml

