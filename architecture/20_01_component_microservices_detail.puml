@startuml microservices_detail
title Service Layer – Microservices Components

skinparam shadowing false
skinparam defaultFontName Arial
skinparam defaultFontSize 11
skinparam rectangle {
  BorderColor #000000
  BorderThickness 1
}

package "Service Layer - Microservices" as SERVICE_LAYER {
  
  package "Agent Service\nservices/agent_ai\nPort: 8000" as AGENT_MS {
    rectangle "**Core Responsibilities**" as AGENT_RESP {
      rectangle "• Agent orchestration (LangGraph)\n• Session & auth management\n• Chat API (sync & streaming)\n• Document upload proxy\n• Tool coordination\n• Memory & state management" as AGENT_DUTIES
    }
    
    package "Components" as AGENT_COMPONENTS {
      rectangle "API Controllers\n(/auth, /chatbot, /documents)" as AGENT_API
      rectangle "LangGraph Agent\n(state machine)" as AGENT_LANGGRAPH
      rectangle "Tool Orchestration\n(RAG, web, analysis)" as AGENT_TOOLS
      rectangle "Session Manager" as AGENT_SESSION
      rectangle "Observability\n(Prometheus, Langfuse)" as AGENT_OBS
    }
    
    rectangle "**Tech Stack**\nFastAPI + LangGraph + SQLModel\nPostgres (sessions, checkpoints)" as AGENT_TECH
  }
  
  package "RAG Service\nservices/rag_api\nPort: 8080" as RAG_MS {
    rectangle "**Core Responsibilities**" as RAG_RESP {
      rectangle "• Document ingestion (15+ formats)\n• Text chunking & embedding\n• Vector similarity search\n• Knowledge graph construction\n• Entity extraction (NER)\n• Access control" as RAG_DUTIES
    }
    
    package "Components" as RAG_COMPONENTS {
      rectangle "Document Controller\n(/embed, /query)" as RAG_API
      rectangle "Processing Pipeline\n(load, extract, chunk)" as RAG_PIPELINE
      rectangle "Embedding Generator\n(async workers)" as RAG_EMBEDDINGS
      rectangle "Vector Store Manager\n(pgvector)" as RAG_VECTOR
      rectangle "Graph Store Manager\n(Neo4j)" as RAG_GRAPH
    }
    
    rectangle "**Tech Stack**\nFastAPI + LangChain\npgvector + Neo4j" as RAG_TECH
  }
  
  package "Analysis Service\n(Future)\nPort: 8090" as ANALYSIS_MS {
    rectangle "**Core Responsibilities**" as ANALYSIS_RESP {
      rectangle "• Strategic decision workflows\n• Rules & compliance validation\n• Scenario simulation (parallel)\n• Optimization algorithms\n• Approval workflows\n• KPI tracking" as ANALYSIS_DUTIES
    }
    
    package "Components" as ANALYSIS_COMPONENTS {
      rectangle "Workflow Controller\n(/analysis/*)" as ANALYSIS_API
      rectangle "Rules Engine\n(compliance)" as ANALYSIS_RULES
      rectangle "Scenario Simulator\n(parallel execution)" as ANALYSIS_SCENARIOS
      rectangle "Optimization Solver\n(strategy generation)" as ANALYSIS_OPTIMIZER
    }
    
    rectangle "**Tech Stack**\nFastAPI + Celery + Ray\nRedis (task queue)" as ANALYSIS_TECH
  }
}

' Service interactions
AGENT_MS --> RAG_MS : HTTP REST + JWT\n(doc ops, RAG search)
AGENT_MS --> ANALYSIS_MS : HTTP REST\n(analysis workflows)
ANALYSIS_MS --> RAG_MS : HTTP REST\n(context retrieval)

' External dependencies
database "Postgres\n+ pgvector" as DB
database "Neo4j" as NEO4J
cloud "OpenAI" as OPENAI
cloud "Observability" as OBS

AGENT_SESSION --> DB : sessions
AGENT_LANGGRAPH --> DB : checkpoints
RAG_VECTOR --> DB : vectors
RAG_GRAPH --> NEO4J : entities
ANALYSIS_MS --> DB : workflows

AGENT_LANGGRAPH --> OPENAI : LLM
RAG_EMBEDDINGS --> OPENAI : embeddings

AGENT_OBS --> OBS
RAG_MS --> OBS
ANALYSIS_MS --> OBS

note bottom of AGENT_MS
**Stateful Microservice**
- Manages conversation context
- Entry point for all user requests
- Orchestrates downstream services
end note

note bottom of RAG_MS
**Stateless Microservice**
- Horizontally scalable
- Data-intensive processing
- Dual storage (vector + graph)
end note

note bottom of ANALYSIS_MS
**Compute Microservice**
- Long-running workflows
- Task queue for async processing
- Can scale workers independently
end note

@enduml

