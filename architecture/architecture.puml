@startuml architecture
title Strategic Planning AI â€“ High-Level Architecture

skinparam componentStyle rectangle
skinparam packageStyle rectangle
skinparam shadowing false
skinparam defaultFontName "Segoe UI"

skinparam rectangle {
  BackgroundColor<<service>> #1F2430
  FontColor<<service>> #FFFFFF
  BorderColor<<service>> #4A90E2
}

skinparam rectangle {
  BackgroundColor<<client>> #203040
  FontColor<<client>> #E5EEF9
  BorderColor<<client>> #77A8FF
}

skinparam rectangle {
  BackgroundColor<<data>> #1E2A23
  FontColor<<data>> #E6F2EA
  BorderColor<<data>> #65C18C
}

' === Client / Edge Layer ===
package "Client Layer" as CLIENT {
  [Mock Tester UI\n(FastAPI /ui page)] <<client>> as MOCK_UI
  [External Integrations\n(REST clients, tools)] <<client>> as EXT_CLIENTS
}

' === Agent Service ===
package "Agent API Service\nservices/agent_ai" as AGENT_SERVICE {
  [Auth & Session API\n(/api/v1/auth/*)] <<service>> as AUTH_API
  [Chatbot API\n(/api/v1/chatbot/*)] <<service>> as CHAT_API
  [Document Proxy API\n(/api/v1/documents/*)] <<service>> as DOC_PROXY
  [LangGraph Orchestrator\n(tools, memory, retries)] <<service>> as LANGGRAPH
  [Metrics & Tracing\n(Prometheus, Langfuse)] <<service>> as OBS_AGENT
}

' === RAG Service ===
package "RAG API Service\nservices/rag_api" as RAG_SERVICE {
  [Upload & Chunking\n(/embed, /embed-upload)] <<service>> as RAG_UPLOAD
  [Vector Search API\n(/query, /query_multiple)] <<service>> as RAG_QUERY
  [Security Middleware\n(JWT validation)] <<service>> as RAG_SEC
  [Async Workers\n(Thread pool, task fanout)] <<service>> as RAG_WORKERS
}

' === Data / Storage ===
database "Postgres + pgvector\n(db container)" <<data>> as PG_DB
[LangGraph Checkpoints\n(checkpoint_* tables)] <<data>> as CHECKPOINTS
[Session & Auth Tables\n(sqlmodel models)] <<data>> as SESSION_DB

' === External Providers ===
cloud "LLM Providers\n(OpenAI GPT, Google Gemini)" as LLM_PROVIDERS
cloud "Embeddings Provider\n(Google Gemini Embeddings)" as EMBEDDINGS
cloud "Observability Stack\n(Prometheus + Grafana)" as OBSERVABILITY
cloud "Langfuse" as LANGFUSE

' === Connections / Data Flows ===
MOCK_UI --> AUTH_API : register / login / create session\n(optional bearer token)
MOCK_UI --> CHAT_API : chat & stream responses
MOCK_UI --> DOC_PROXY : upload docs, list file_ids, preview chunks
EXT_CLIENTS --> AUTH_API
EXT_CLIENTS --> CHAT_API

AUTH_API --> SESSION_DB : create users, guest account, sessions
AUTH_API --> CHECKPOINTS : provision thread IDs

CHAT_API --> LANGGRAPH : invoke workflow per session
CHAT_API --> SESSION_DB : rate limiting, validator (read-only)
CHAT_API --> CHECKPOINTS : persist conversation state

LANGGRAPH --> RAG_QUERY : rag_search tool\n(JWT-authenticated call)
LANGGRAPH --> LLM_PROVIDERS : send prompts / receive completions
LANGGRAPH --> CHECKPOINTS : load/store state snapshots

DOC_PROXY --> RAG_UPLOAD : signed pass-through for files

RAG_UPLOAD --> RAG_WORKERS : async parsing, chunking
RAG_UPLOAD --> EMBEDDINGS : embed documents
RAG_UPLOAD --> PG_DB : store chunks & vectors

RAG_QUERY --> PG_DB : similarity search (pgvector)
RAG_QUERY --> RAG_WORKERS

CHAT_API --> OBS_AGENT
CHAT_API --> LANGFUSE
LANGGRAPH --> OBS_AGENT
LANGGRAPH --> LANGFUSE

RAG_SERVICE --> OBSERVABILITY
AGENT_SERVICE --> OBSERVABILITY

SESSION_DB --> PG_DB
CHECKPOINTS --> PG_DB

' === Notes ===
note bottom of AGENT_SERVICE
FastAPI + uvicorn
LangGraph agent with rag_search & duckduckgo tools
Optional anonymous sessions (guest user)
end note

note bottom of RAG_SERVICE
FastAPI + uvicorn
Handles uploads, chunking, embeddings, and vector search
Requires shared JWT secret with Agent API
end note

note bottom of PG_DB
ankane/pgvector image (Docker)
Stores chat state + vector embeddings in separate schemas
end note

@enduml
